<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.theantiquersroom.myapp.mapper.UserMapper">

    <!-- 전체 회원 목록 조회 -->
    <select
            id="getUserList"
            resultType="com.theantiquersroom.myapp.domain.UserDTO">

       <![CDATA[
            SELECT
                user_id as userId,
                password,
                nickname,
                phone,
                user_type as userType
            FROM users
       ]]>
    </select>

    <!-- 회원가입 -->
    <insert
            id="insertUser"
            parameterType="com.theantiquersroom.myapp.domain.UserDTO">

        <![CDATA[
            INSERT INTO users(USER_ID, PASSWORD, NICKNAME, PHONE, USER_TYPE)
            VALUES (#{userId}, #{password}, #{nickName}, #{phone}, 2)
        ]]>
    </insert>

    <!-- 인증번호 INSERT-->
    <insert
            id="insertAuthorizationNumber"
            parameterType="string">

        <![CDATA[
	        REPLACE INTO authkey(userid, auth, updatedate)
	        VALUES (#{userId}, #{auth}, now())
        ]]>
    </insert>

    <!-- emailchecktemp table의 auth 조회 -->
    <select id="selectAuth"
            parameterType="String"
            resultType="String">
            
        <![CDATA[
            SELECT auth from authkey
            WHERE userId = #{userId}
            AND updatedate BETWEEN DATE_SUB(now(), interval 3 minute) AND now()
        ]]>
    </select>

    <!-- 비밀번호 재설정  -->
    <update
            id="updatePassword"
            parameterType="String">
            
        <![CDATA[
        	UPDATE users SET password = #{newPassword} where user_id = #{userId}
        ]]>
    </update>

    <!-- 특정 아이디 조회 -->
    <select
            id="getUserId"
            resultType="String"
            parameterType="String"
    >
        <![CDATA[
			
		  SELECT user_id FROM users WHERE user_id = #{userId}
		  
        ]]>
    </select>

    <!-- 특정 닉네임 조회 -->
    <select
            id="getNickName"
            resultType="String"
			parameterType="String"          
    >
        <![CDATA[
        
        	SELECT nickname FROM users WHERE nickname = #{nickname}

        ]]>
    </select>

    <!-- 특정 연락처 조회 -->
    <select
            id="getPhone"
            resultType="String"
            parameterType="String"
            >
        <![CDATA[
			SELECT phone FROM users WHERE phone = #{phone}
        ]]>
    </select>

    <!-- 로그인 -->
    <select
            id="selectUserById"
            resultType="com.theantiquersroom.myapp.domain.UserDTO">

        <![CDATA[
            SELECT 
				user_id as userId,
				password,
				nickname,
				phone,
				user_type as userType
            FROM users
            WHERE user_id=#{userId}
        ]]>
    </select>
    
    <select 
        id="read"
        resultType="com.theantiquersroom.myapp.domain.UserVO">
        
        <![CDATA[
			SELECT
			    user_id as userId,
			    password,
			    nickname,
			    phone,
			    user_type as userType,
			    kakao_unique_id
			FROM users
			WHERE user_id=#{userId}
       ]]>
    </select>
    
       <!-- 닉네임, 전화번호로 아이디찾기  -->
    <select
            id="findId"
            resultType="com.theantiquersroom.myapp.domain.UserVO">
            
		SELECT * FROM users WHERE nickname=#{nickName} AND phone=#{phone}    
	</select>

        <!-- 회원 정보 삭제 -->
    
    <delete id="delete">
        DELETE FROM users WHERE user_id=#{userId}
    </delete>
    
    
    <!-- 회원 정보 수정 -->
	<update id="update">
	
		<![CDATA[     
	        UPDATE users
	        SET 
	    	    password=#{password},
	            nickname=#{nickName},
	            phone=#{phone}
	        WHERE
	            user_id=#{userId}
		]]>
	</update>
	
	
	<!-- 마이페이지 게시판 총 목록개수 반환 -->
    <select
        id="getMyAuctionTotalCount"
        resultType="int">
        
        <![CDATA[

            SELECT count(p_id)
            FROM product
            WHERE user_id=#{userId}

        ]]>
    </select>
           
           
    <!-- 마이페이지-나의경매리스트 조회 -->
    <select
        id="getMyAuctionList"
        resultType="com.theantiquersroom.myapp.domain.ProductDTO"
        parameterType="hashmap">

        <![CDATA[ 

            SELECT
            	A.p_id as pId,
                A.name,
                A.created_at as createdAt,
                A.updated_at as updatedAt,
                A.content,
                A.category_id as categoryId,
                A.user_id as userId,
                A.started_at as startedAt,
                A.ended_at as endedAt,
                A.started_price as startedPrice,
                A.bid_increment as bidIncrement,
                A.status,
                (select nickname from users as B where B.USER_ID=#{userId}) as nickname,
                (select category_name from category as C where C.category_id=A.category_id) as categoryName
            FROM product as A
            WHERE A.user_id=#{userId}
            ORDER BY A.created_at DESC
            LIMIT #{cri.pageStart}, #{cri.amount}
 

        ]]>
    </select>       
            

    <!-- 카카오 아이디 조회  -->
    <select
            id="getKakaoUser"
            resultType="com.theantiquersroom.myapp.domain.UserDTO"
            parameterType="string">
            
        <![CDATA[
          SELECT * FROM users WHERE kakao_unique_id = #{kakaoUniqueId}
        ]]>
    </select>
    
</mapper>